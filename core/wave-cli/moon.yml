language: "rust"
type: "application"
owners:
  defaultOwner: "@wave-autoscale-team"

tasks:
  test:
    command: "cargo nextest run -p wave-cli"
    inputs:
      - "@globs(sources)"
    env:
      RUST_LOG: debug
  copy-wave-controller:
    command: "cp ../../target/aarch64-apple-darwin/release/wave-controller ./wave-controller"
    platform: "system"
    deps:
      - "controller:build-aarch64-apple-darwin"
    outputs:
      - "./wave-controller"
    env:
      RUST_LOG: info
  copy-wave-metrics:
    command: "cp ../../target/aarch64-apple-darwin/release/wave-metrics ./wave-metrics"
    platform: "system"
    deps:
      - "wave-metrics:build-aarch64-apple-darwin"
    outputs:
      - "./wave-metrics"
    env:
      RUST_LOG: info
  copy-wave-api-server:
    command: "cp ../../target/aarch64-apple-darwin/release/wave-api-server ./wave-api-server"
    platform: "system"
    deps:
      - "api-server:build-aarch64-apple-darwin"
    outputs:
      - "./wave-api-server"
    env:
      RUST_LOG: info
  run-help:
    command: "cargo watch -c -x 'run -- --help'"
    deps:
      - "lint"
    inputs:
      - "@globs(sources)"
    env:
      RUST_LOG: info
  run:
    command:
      - "cargo"
      - "run"
      - "--"
      - "--run-metrics"
      - "--run-api-server"
      - "--config=../../tests/yaml/wave-config.yaml"
      - "--definition=./tests/yaml/definition.yaml"
      - "--collectors-info=../wave-metrics/tests/yaml/collectors.yaml"
    deps:
      - "lint"
      # TODO: Build web-app
      - "copy-wave-controller"
      - "copy-wave-metrics"
      - "copy-wave-api-server"
    inputs:
      - "@globs(sources)"
      - "tests/yaml/definition.yaml"
      - "/core/wave-metrics/tests/yaml/collectors.yaml"
      - "/tests/yaml/wave-config.yaml"
    outputs:
      - "wave-controller"
      - "wave-api-server"
      - "wave-metrics"
      - "wave-web-app/**/*"
    env:
      RUST_LOG: wave_cli=debug

  # Build for Production
  # Linux
  build-aarch64-unknown-linux-gnu:
    command: "cargo build --release --target aarch64-unknown-linux-gnu"
    inputs:
      - "@globs(sources)"
  build-aarch64-unknown-linux-musl:
    command: "cargo build --release --target aarch64-unknown-linux-musl"
    inputs:
      - "@globs(sources)"
  build-x86_64-unknown-linux-gnu:
    command: "cargo build --release --target x86_64-unknown-linux-gnu"
    inputs:
      - "@globs(sources)"
  build-x86_64-unknown-linux-musl:
    command: "cargo build --release --target x86_64-unknown-linux-musl"
    inputs:
      - "@globs(sources)"
  # Mac
  build-x86_64-apple-darwin:
    command: "cargo build --release --target x86_64-apple-darwin"
    inputs:
      - "@globs(sources)"
  build-aarch64-apple-darwin:
    command: "cargo build --release --target aarch64-apple-darwin"
    inputs:
      - "@globs(sources)"
    outputs:
      - "/target/aarch64-apple-darwin/release/wave-cli"
