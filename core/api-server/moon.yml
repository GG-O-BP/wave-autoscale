language: "rust"
type: "library"
owners:
  defaultOwner: "@wave-autoscale-team"

dependsOn:
  - "data-layer"

tasks:
  test:
    command: "cargo nextest run -p api-server"
    deps:
      - "utils:test"
      - "data-layer:test"
    env:
      RUST_LOG: wave_api_server=debug
  run:
    command:
      - "cargo"
      - "run"
      - "-p"
      - "api-server"
      - "--"
      - "--config"
      - "./tests/config/wave-config.yaml"
    env:
      RUST_LOG: wave_api_server=debug
  # Build for Production
  # Linux
  build-aarch64-unknown-linux-gnu:
    command: "cargo build --release --target aarch64-unknown-linux-gnu"
    deps:
      - "test"
    inputs:
      - "@globs(sources)"
  build-aarch64-unknown-linux-musl:
    command: "cargo build --release --target aarch64-unknown-linux-musl"
    deps:
      - "test"
    inputs:
      - "@globs(sources)"
  build-x86_64-unknown-linux-gnu:
    command: "cargo build --release --target x86_64-unknown-linux-gnu"
    deps:
      - "test"
    inputs:
      - "@globs(sources)"
  build-x86_64-unknown-linux-musl:
    command: "cargo build --release --target x86_64-unknown-linux-musl"
    deps:
      - "test"
    inputs:
      - "@globs(sources)"
  # Mac
  build-x86_64-apple-darwin:
    command: "cargo build --release --target x86_64-apple-darwin"
    deps:
      - "test"
    inputs:
      - "@globs(sources)"
  build-aarch64-apple-darwin:
    command: "cargo build --release --target aarch64-apple-darwin"
    deps:
      - "test"
    inputs:
      - "@globs(sources)"
    outputs:
      - "/target/aarch64-apple-darwin/release/wave-api-server"
