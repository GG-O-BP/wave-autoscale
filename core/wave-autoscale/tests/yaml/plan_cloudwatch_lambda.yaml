---
kind: Metric
id: cloudwatch_provisioned_concurrent_executions_avg
metric_kind: cloudwatch-data
metadata:
  region: ap-northeast-3
  access_key: AKIA5TOD4EBPANTGF4XJ
  secret_key: CYek4vOKaCDTXzlkfMBhO1o19NcLsjEN9cx
  polling_interval: 60000
  # https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_GetMetricData.html
  # https://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/API_MetricDataQuery.html
  expression: 'SELECT AVG(ProvisionedConcurrentExecutions) FROM SCHEMA("AWS/Lambda", FunctionName) WHERE FunctionName = 'test-lambda-function''
  period: 10
  duration_seconds: 30
---
kind: ScalingComponent
id: scaling_component_lambda_function
component_kind: aws-lambda
metadata:
  region: ap-northeast-3
  access_key: AKIA5TOD4EBPANTGF4XJ
  secret_key: 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
  function_name: test-lambda-function
  qualifier: latest
---
kind: ScalingPlan
id: scaling_plan_lambda_function
title: "Scaling Plan for Lambda Function"
plans:
  - id: scale-out-plan-1
    description: "Scale out 10 functions if provisioned concurrent executions value is greater than 90%."
    # JavaScript expression that returns a boolean value.
    expression: "cloudwatch_provisioned_concurrent_executions_avg >= 0.9"
    # Higher priority values will be checked first.
    priority: 1
    scaling_components:
      - component_id: scaling_component_lambda_function
        # JavaScript expression that returns an integer.
        reserved_concurrency: "11"
        provisioned_concurrency: "11"  
  - id: scale-in-plan-1
    description: "Scale in 10 functions if provisioned concurrent executions value is less than 50%."
    # JavaScript expression that returns a boolean value.
    expression: "cloudwatch_provisioned_concurrent_executions_avg <= 0.5"
    # Higher priority values will be checked first.
    priority: 2
    scaling_components:
      - component_id: scaling_component_lambda_function
        # JavaScript expression that returns an integer.
        reserved_concurrency: "6"
        provisioned_concurrency: "6"  
