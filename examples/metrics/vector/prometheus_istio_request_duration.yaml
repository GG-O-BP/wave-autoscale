# We obtain the Istio request duration metric value from Prometheus through the vector agent.
kind: Metric
id: prometheus_istio_request_duration_1m
collector: vector
metadata:
  sources:
    my_source_id_1:
      type: http_client
      # If you use the Prometheus endpoint at `/api/v1/query`, you will receive a value in JSON format.
      # Therefore, you need to use Vector's transforms to convert it to match the format of wave-autoscale.
      endpoint: "http://localhost:9090/api/v1/query"
      scrape_interval_secs: 30
      query:
        "query":
          [
            'rate(istio_request_duration_milliseconds_sum{response_code="200"}[1m])',
          ]
  transforms:
    my_transforms_id_1:
      inputs: ["my_source_id_1"]
      type: remap
      # - The metric format for wave-autoscale is as follows:
      #   {"name": "name_1", "tags": {"tag_id": "tag1"}, "timestamp": 1698122911, "gauge": {"value" : 10.1}}
      # - Both 'tags' and 'timestamp' are optional.
      # - gauge.value must be a number.
      # - VRL Playground - https://playground.vrl.dev/
      # - endpoint metric data example:
      #   {"status": "success", "data": {"resultType": "vector", "result": [{"metric": {"destination_app": "order-server"}, "value": [1698134195.218, "0"]}, {"metric": {"connection_security_policy": "mutual_tls"}, "value": [1698134195.218, "0"]}, {"metric": {"connection_security_policy": "unknown"}, "value": [1698134195.218, "0"]}]}}
      source: |-
        . = parse_json!(.message)
        tally = []
        for_each(array!(.data.result)) -> |_index, value| {
            tally = push(tally, {"name": "name_1", "tags": value.metric, "timestamp": value.value[0], "gauge": {"value" : to_float!(value.value[1])}})
        }
        tally
        . = tally
  sinks:
    my_sinks_id:
      # The 'sinks' type in Vector should be set to 'wave-autoscale'.
      type: wave-autoscale
      # For the 'inputs' value, you should basically provide the 'id' value from 'sources'.
      # If there are 'transforms', you can input the 'id' of the last transformed form.
      inputs: ["my_transforms_id_1"]
########### [ Saved Metric Data Example ] ############
# {
#   [{"name":"name_1","tags":{"connection_security_policy":"mutual_tls","destination_app":"order-server","destination_canonical_revision":"latest","destination_canonical_service":"order-server","destination_cluster":"Kubernetes","destination_principal":"spiffe://cluster.local/ns/wave-autoscale/sa/default","destination_service":"order-server-sv.wave-autoscale.svc.cluster.local","destination_service_name":"order-server-sv","destination_service_namespace":"wave-autoscale","destination_workload":"order-server-dp","destination_workload_namespace":"wave-autoscale","instance":"172.31.29.162:15090","job":"envoy-stats","reporter":"destination","request_protocol":"http","response_code":"200","response_flags":"-","source_app":"istio-ingressgateway","source_canonical_revision":"latest","source_canonical_service":"istio-ingressgateway","source_cluster":"Kubernetes","source_principal":"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway","source_version":"unknown","source_workload":"istio-ingressgateway","source_workload_namespace":"istio-system"},"value":"0","timestamp":1698304631.731},{"name":"name_1","tags":{"connection_security_policy":"mutual_tls","destination_app":"product-server","destination_canonical_revision":"latest","destination_canonical_service":"product-server","destination_cluster":"Kubernetes","destination_principal":"spiffe://cluster.local/ns/wave-autoscale/sa/default","destination_service":"product-server-sv.wave-autoscale.svc.cluster.local","destination_service_name":"product-server-sv","destination_service_namespace":"wave-autoscale","destination_workload":"product-server-dp","destination_workload_namespace":"wave-autoscale","instance":"172.31.39.238:15090","job":"envoy-stats","reporter":"destination","request_protocol":"http","response_code":"200","response_flags":"-","source_app":"istio-ingressgateway","source_canonical_revision":"latest","source_canonical_service":"istio-ingressgateway","source_cluster":"Kubernetes","source_principal":"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway","source_version":"unknown","source_workload":"istio-ingressgateway","source_workload_namespace":"istio-system"},"value":"0","timestamp":1698304631.731},{"name":"name_1","tags":{"connection_security_policy":"unknown","destination_app":"order-server","destination_canonical_revision":"latest","destination_canonical_service":"order-server","destination_cluster":"Kubernetes","destination_principal":"spiffe://cluster.local/ns/wave-autoscale/sa/default","destination_service":"order-server-sv.wave-autoscale.svc.cluster.local","destination_service_name":"order-server-sv","destination_service_namespace":"wave-autoscale","destination_version":"unknown","destination_workload":"order-server-dp","destination_workload_namespace":"wave-autoscale","instance":"172.31.34.170:15090","job":"envoy-stats","reporter":"source","request_protocol":"http","response_code":"200","response_flags":"-","source_app":"istio-ingressgateway","source_canonical_revision":"latest","source_canonical_service":"istio-ingressgateway","source_cluster":"Kubernetes","source_principal":"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway","source_workload":"istio-ingressgateway","source_workload_namespace":"istio-system"},"value":"0","timestamp":1698304631.731},{"name":"name_1","tags":{"connection_security_policy":"unknown","destination_app":"product-server","destination_canonical_revision":"latest","destination_canonical_service":"product-server","destination_cluster":"Kubernetes","destination_principal":"spiffe://cluster.local/ns/wave-autoscale/sa/default","destination_service":"product-server-sv.wave-autoscale.svc.cluster.local","destination_service_name":"product-server-sv","destination_service_namespace":"wave-autoscale","destination_version":"unknown","destination_workload":"product-server-dp","destination_workload_namespace":"wave-autoscale","instance":"172.31.34.170:15090","job":"envoy-stats","reporter":"source","request_protocol":"http","response_code":"200","response_flags":"-","source_app":"istio-ingressgateway","source_canonical_revision":"latest","source_canonical_service":"istio-ingressgateway","source_cluster":"Kubernetes","source_principal":"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway","source_workload":"istio-ingressgateway","source_workload_namespace":"istio-system"},"value":"0","timestamp":1698304631.731},{"name":"name_1","tags":{"connection_security_policy":"unknown","destination_app":"product-server","destination_canonical_revision":"latest","destination_canonical_service":"product-server","destination_cluster":"Kubernetes","destination_principal":"spiffe://cluster.local/ns/wave-autoscale/sa/default","destination_service":"product-server-sv.wave-autoscale.svc.cluster.local","destination_service_name":"product-server-sv","destination_service_namespace":"wave-autoscale","destination_version":"unknown","destination_workload":"product-server-dp","destination_workload_namespace":"wave-autoscale","instance":"172.31.34.170:15090","job":"envoy-stats","reporter":"source","request_protocol":"http","response_code":"200","response_flags":"DI","source_app":"istio-ingressgateway","source_canonical_revision":"latest","source_canonical_service":"istio-ingressgateway","source_cluster":"Kubernetes","source_principal":"spiffe://cluster.local/ns/istio-system/sa/istio-ingressgateway","source_workload":"istio-ingressgateway","source_workload_namespace":"istio-system"},"value":"0","timestamp":1698304631.731},{"name":"name_1","tags":{"connection_security_policy":"unknown","destination_app":"unknown","destination_canonical_revision":"2.47.0","destination_canonical_service":"prometheus","destination_cluster":"Kubernetes","destination_principal":"unknown","destination_service":"prometheus-community-kube-prometheus.istio-system.svc.cluster.local","destination_service_name":"prometheus-community-kube-prometheus","destination_service_namespace":"istio-system","destination_version":"unknown","destination_workload":"prometheus-prometheus-community-kube-prometheus","destination_workload_namespace":"istio-system","instance":"172.31.34.170:15090","job":"envoy-stats","reporter":"source","request_protocol":"http","response_code":"200","response_flags":"-","source_app":"istio-ingressgateway","source_canonical_revision":"latest","source_canonical_service":"istio-ingressgateway","source_cluster":"Kubernetes","source_principal":"unknown","source_workload":"istio-ingressgateway","source_workload_namespace":"istio-system"},"value":"0.1349999999998545","timestamp":1698304631.731},{"name":"name_1","tags":{"connection_security_policy":"unknown","destination_app":"unknown","destination_canonical_revision":"latest","destination_canonical_service":"grafana","destination_cluster":"Kubernetes","destination_principal":"unknown","destination_service":"prometheus-community-grafana.istio-system.svc.cluster.local","destination_service_name":"prometheus-community-grafana","destination_service_namespace":"istio-system","destination_version":"unknown","destination_workload":"prometheus-community-grafana","destination_workload_namespace":"istio-system","instance":"172.31.34.170:15090","job":"envoy-stats","reporter":"source","request_protocol":"http","response_code":"200","response_flags":"-","source_app":"istio-ingressgateway","source_canonical_revision":"latest","source_canonical_service":"istio-ingressgateway","source_cluster":"Kubernetes","source_principal":"unknown","source_workload":"istio-ingressgateway","source_workload_namespace":"istio-system"},"value":"0","timestamp":1698304631.731},{"name":"name_1","tags":{"connection_security_policy":"unknown","destination_app":"unknown","destination_canonical_revision":"v1.74.0","destination_canonical_service":"kiali","destination_cluster":"Kubernetes","destination_principal":"unknown","destination_service":"kiali.istio-system.svc.cluster.local","destination_service_name":"kiali","destination_service_namespace":"istio-system","destination_version":"unknown","destination_workload":"kiali","destination_workload_namespace":"istio-system","instance":"172.31.34.170:15090","job":"envoy-stats","reporter":"source","request_protocol":"http","response_code":"200","response_flags":"-","source_app":"istio-ingressgateway","source_canonical_revision":"latest","source_canonical_service":"istio-ingressgateway","source_cluster":"Kubernetes","source_principal":"unknown","source_workload":"istio-ingressgateway","source_workload_namespace":"istio-system"},"value":"0","timestamp":1698304631.731}]
# }
######################################################
